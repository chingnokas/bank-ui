name: Simple CI (OpenTofu + Kubernetes)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  CLUSTER_NAME: banking-app-k8s
  DO_REGION: nyc1

jobs:
  provision-cluster:
    name: Provision Kubernetes cluster (OpenTofu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.DIGITALOCEAN_TOKEN }}" ]; then
            echo "DIGITALOCEAN_TOKEN is not set in repo secrets" >&2
            exit 1
          fi

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0

      - name: Install doctl (DigitalOcean CLI)
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Determine supported Kubernetes version
        id: k8sver
        run: |
          # Get first available supported version (GA) from DigitalOcean
          ver=$(doctl kubernetes options versions | grep -E '[0-9]+\.[0-9]+\.[0-9]+-do\.[0-9]+' | head -n1 | awk '{print $1}')
          if [ -z "$ver" ]; then
            echo "Failed to resolve a supported Kubernetes version" >&2
            exit 1
          fi
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Init/Plan/Apply infrastructure
        working-directory: infra
        run: |
          tofu init -input=false
          tofu plan -input=false -out=tfplan \
            -var="do_token=${{ secrets.DIGITALOCEAN_TOKEN }}" \
            -var="cluster_name=${{ env.CLUSTER_NAME }}" \
            -var="region=${{ env.DO_REGION }}" \
            -var="k8s_version=${{ steps.k8sver.outputs.version }}"
          tofu apply -input=false -auto-approve tfplan

      - name: Wait for cluster to be ready
        run: |
          doctl kubernetes cluster kubeconfig save "${{ env.CLUSTER_NAME }}"
          kubectl cluster-info
          kubectl get nodes -o wide
          echo "Waiting for all nodes to be Ready..."
          kubectl wait --for=condition=Ready nodes --all --timeout=600s

  deploy:
    name: Deploy Kubernetes manifests
    runs-on: ubuntu-latest
    needs: provision-cluster
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl (DigitalOcean CLI)
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Configure kubectl
        run: |
          doctl kubernetes cluster kubeconfig save "${{ env.CLUSTER_NAME }}"
          kubectl cluster-info

      - name: Create namespace and base secrets
        run: |
          kubectl apply -f k8s/namespace.yaml
          # NOTE: banking-secrets.yaml should be a template-safe file (no real secrets in repo)
          kubectl apply -f k8s/secrets/banking-secrets.yaml

      - name: Deploy database
        run: |
          # Handle StatefulSet immutable field updates by deleting if it exists
          if kubectl get statefulset postgres -n banking-app &>/dev/null; then
            echo "Existing postgres StatefulSet found, deleting to avoid immutable field conflicts..."
            kubectl delete statefulset postgres -n banking-app --wait=true
          fi
          kubectl apply -f k8s/database/

      - name: Deploy backend
        run: |
          kubectl apply -f k8s/backend/
          kubectl -n banking-app rollout status deployment/banking-backend --timeout=300s

      - name: Deploy frontend
        run: |
          kubectl apply -f k8s/frontend/
          kubectl -n banking-app rollout status deployment/banking-frontend --timeout=300s
